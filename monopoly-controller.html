<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="monopoly-controller">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <h3>players:</h3>
    <template is="dom-repeat" items="[[allPlayers]]" as="props">
      <p>
        <span> <b>id:</b> {{props.id}}</span><span> <b>alias:</b> {{props.alias}}</span>
        <span> <b>amount:</b> {{props.amount}}</span><span> <b>status:</b> {{props.status}}</span>
      </p>
    </template>
    <h3>properties:</h3>
    <template is="dom-repeat" items="[[allProperties]]" as="props">
      <p>
        <span> <b>id:</b> {{props.id}}</span><span> <b>name:</b> {{props.name}}</span>
        <span> <b>owner:</b> {{props.owner}}</span><span> <b>price:</b> {{props.price}}</span>
      </p>
    </template>
    <h3>transactions:</h3>
    <template is="dom-repeat" items="[[allTransactions]]" as="props">
      <p>
        <span> <b>id:</b> {{props.id}}</span><span> <b>to:</b> {{props.to}}</span>
        <span> <b>from:</b> {{props.from}}</span><span> <b>amount:</b> {{props.amount}}</span>
        <span> <b>timestamp:</b> {{props.timestamp.date}} {{props.timestamp.time}}</span>
      </p>
    </template>
  </template>
  <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase.js"></script>
  <script>
    class MonopolyController extends Polymer.Element {
      static get is() { return 'monopoly-controller'; }
      static get properties() {
        return {
          config: {
            type: Object,
          },
          database: {
            type: Object,
          },
          query: {
            type: String,
            value: '',
            reflectToAttribute: true,
            observer: 'sendQuery',
          },
          allPlayers: {
            type: Array,
          },
          allProperties: {
            type: Array,
          },
          allTransactions: {
            type: Array,
          },
        };
      }

      constructor() {
        super();
        this.config = {
          apiKey: "AIzaSyCXWKfiFInlVvHKGVni4fFbKAg8Adr2sQI",
          authDomain: "monopoly-transac.firebaseapp.com",
          databaseURL: "https://monopoly-transac.firebaseio.com",
          projectId: "monopoly-transac",
          storageBucket: "monopoly-transac.appspot.com",
          messagingSenderId: "488537332296"
        };
        firebase.initializeApp(this.config);
        this.database = firebase.database();
        this.allPlayers = {};
        this.allProperties = {};
        this.allTransactions = {};
      }

      connectedCallback() {
        super.connectedCallback();
      }

      // transpile the format of firebase json to noSQL standar json
      jsonTranspiler(snapshot) {
        let i = 0;
        let array = [];
        let object = {};
        let dataValues = {};
        snapshot.forEach(data => {
          object['id'] = data.key;
          dataValues = data.val();
          for (const prop in dataValues) {
            object[prop] = dataValues[prop];
          }
          array[i] = object;
          i++;
          object = {};
        });
        return array;
      }

      sendQuery() {
        if (this.query==='getPlayers') {
          this.getPlayers();
        }
        else if (this.query==='getProperties') {
          this.getProperties();
        }
        else if (this.query==='getTransactions') {
          this.getTransactions();
        }
      }

      getPlayers() {
        this.database.ref('players/').on("value", snapshot => {
          this.allPlayers = this.jsonTranspiler(snapshot);
          this.dispatchEvent(new CustomEvent('get-players', {
            bubles: true,
            composed: true,
            detail: this.allPlayers
          }));
        });
      }

      getProperties() {
        this.database.ref('properties/').on("value", snapshot => {
          this.allProperties = this.jsonTranspiler(snapshot);
          this.dispatchEvent(new CustomEvent('get-properties', {
            bubles: true,
            composed: true,
            detail: this.allProperties
          }));
        });
      }

      getTransactions() {
        this.database.ref('transactions/').on("value", snapshot => {
          this.allTransactions = this.jsonTranspiler(snapshot);
          this.dispatchEvent(new CustomEvent('get-transactions', {
            bubles: true,
            composed: true,
            detail: this.allTransactions
          }));
        });
      }
    }

    window.customElements.define(MonopolyController.is, MonopolyController);
  </script>
</dom-module>
