<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="monopoly-controller">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <h3>players:</h3>
    <template is="dom-repeat" items="[[allPlayers]]" as="props">
      <p>
        <span> <b>id:</b> {{props.id}}</span><span> <b>alias:</b> {{props.alias}}</span>
        <span> <b>amount:</b> {{props.amount}}</span><span> <b>status:</b> {{props.status}}</span>
      </p>
    </template>
    <h3>properties:</h3>
    <template is="dom-repeat" items="[[allProperties]]" as="props">
      <p>
        <span> <b>id:</b> {{props.id}}</span><span> <b>name:</b> {{props.name}}</span>
        <span> <b>owner:</b> {{props.owner}}</span><span> <b>price:</b> {{props.price}}</span>
      </p>
    </template>
    <h3>transactions:</h3>
    <template is="dom-repeat" items="[[allTransactions]]" as="props">
      <p>
        <span> <b>id:</b> {{props.id}}</span><span> <b>to:</b> {{props.to}}</span>
        <span> <b>from:</b> {{props.from}}</span><span> <b>amount:</b> {{props.amount}}</span>
        <span> <b>timestamp:</b> {{props.timestamp.date}} {{props.timestamp.time}}</span>
      </p>
    </template>
    <h3>Specific player:</h3>    
    <p>
      <span> <b>id:</b> {{player.id}}</span><span> <b>alias:</b> {{player.alias}}</span>
      <span> <b>amount:</b> {{player.amount}}</span><span> <b>status:</b> {{player.status}}</span>      
    </p>          
    <h3>Specific property:</h3>    
    <p>
      <span> <b>id:</b> {{property.id}}</span><span> <b>name:</b> {{property.name}}</span>
      <span> <b>owner:</b> {{property.owner}}</span><span> <b>price:</b> {{property.price}}</span>      
    </p>      

    <h3>All Transacctions from  a specific player (TO):</h3>        
    <template is="dom-repeat" items="[[transacByPlayerTo]]" as="props">
    <p>
      <span> <b>id:</b> {{props.id}}</span><span><b>from:</b> {{props.from}}</span><span><b>to:</b> {{props.to}}</span>
      <span> <b>amount:</b> {{props.amount}}</span><span> <b>timestamp:</b> {{props.timestamp.date}} :  {{props.timestamp.time}}</span>            
    </p>      
    </template>

    <h3>All Transacctions from  a specific player (FROM):</h3>        
    <template is="dom-repeat" items="[[transacByPlayerFrom]]" as="props">
    <p>
      <span> <b>id:</b> {{props.id}}</span><span><b>from:</b> {{props.from}}</span><span><b>to:</b> {{props.to}}</span>
      <span> <b>amount:</b> {{props.amount}}</span><span> <b>timestamp:</b> {{props.timestamp.date}} :  {{props.timestamp.time}}</span>            
    </p>      
    </template>

    <h3>All Properties  from  a specific player </h3>        
    <template is="dom-repeat" items="[[propertiesByOwner]]" as="props">
    <p>
        <span> <b>id:</b> {{props.id}}</span><span> <b>name:</b> {{props.name}}</span>
        <span> <b>owner:</b> {{props.owner}}</span><span> <b>price:</b> {{props.price}}</span>
    </p>      
    </template>

  </template>
  <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase.js"></script>
  <script>
    class MonopolyController extends Polymer.Element {
      static get is() { return 'monopoly-controller'; }
      static get properties() {
        return {
          config: {
            type: Object,
          },
          database: {
            type: Object,
          },
          allPlayers: {
            type: Array,
          }, 
          allProperties: {
            type: Array,
          },
          allTransactions: {
            type: Object,
            value: {}
          },
          player: {
            type: Object,            
          },
          property: {
            type: Object,            
          },
          transacByPlayerTo: {
            type: Object,            
          },
          transacByPlayerFrom: {
            type: Object,            
          },
          propertiesByOwner: {
            type: Object,            
          },
        };
      }
      constructor() {
        super();
        this.config = {
          apiKey: "AIzaSyCXWKfiFInlVvHKGVni4fFbKAg8Adr2sQI",
          authDomain: "monopoly-transac.firebaseapp.com",
          databaseURL: "https://monopoly-transac.firebaseio.com",
          projectId: "monopoly-transac",
          storageBucket: "monopoly-transac.appspot.com",
          messagingSenderId: "488537332296"
        };
        firebase.initializeApp(this.config);
        this.database = firebase.database();
        this.allPlayers = {};
        this.allProperties = {};
      }
      connectedCallback() {
        super.connectedCallback();
        this.getPlayers();
        this.getProperties();
        this.getTransactions();
        this.getPlayer('-LDIgtcsdt1x9xCEsq11');
        this.getProperty('-LDIj1VlS1CNpoMj7ndT');
        this.getTransacByPlayerTo('-LDIgtcsdt1x9xCEsq11','to');
        this.getTransacByPlayerTo('-LDIgtcsdt1x9xCEsq11','from');
        this.getPropertiesByOwner('-LDIgtcsdt1x9xCEsq11');
        
      }
      // transpile the format of firebase json to noSQL standar json
      jsonTranspiler(snapshot) {
        let i = 0;
        let array = [];
        let object = {};
        let dataValues = {};
        snapshot.forEach(data => {
          object['id'] = data.key;
          dataValues = data.val();
          for (const prop in dataValues) {
            object[prop] = dataValues[prop];
          }
          array[i] = object;
          i++;
          object = {};
        });
        console.log(array);
        return array;
      }
      getPlayers() {
        this.database.ref('players/').on("value", snapshot => {
          this.allPlayers = this.jsonTranspiler(snapshot);
        });
      }
      getProperties() {
        this.database.ref('properties/').on("value", snapshot => {
          this.allProperties = this.jsonTranspiler(snapshot);
        });
      }
      getTransactions() {
        this.database.ref('transactions/').on("value", snapshot => {
          this.allTransactions = this.jsonTranspiler(snapshot);
        });
      }
      getPlayer(id) {
        this.database.ref('players/'+id).on("value", snapshot => {                    
          this.set('player',snapshot.val());
          this.set('player.id',id);          
        });        
      }
      getProperty(id) {
        this.database.ref('properties/'+id).on("value", snapshot => {                    
          this.set('property',snapshot.val());
          this.set('property.id',id);          
        });        
      }
      getTransacByPlayerTo(id,type) {
        this.database.ref('transactions').orderByChild(type).equalTo(id).on("value", snapshot => { 
            if(type === 'to') { this.transacByPlayerTo = this.jsonTranspiler(snapshot); }
            if(type === 'from') { this.transacByPlayerFrom = this.jsonTranspiler(snapshot); }
        });        
      }
      getPropertiesByOwner(idOwner) {
        this.database.ref('properties').orderByChild('owner').equalTo(idOwner).on("value", snapshot => { 
            this.propertiesByOwner = this.jsonTranspiler(snapshot);             
        });        
      }
    }
    window.customElements.define(MonopolyController.is, MonopolyController);
  </script>
</dom-module>

//admin.database().ref('persons').orderByChild('Firstname').equalTo(firstName).limitToLast(1).once("value").then(function(snapshot) {
//}

